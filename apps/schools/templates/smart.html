{% include 'partials/header.html' %}
{% include 'partials/navbar.html' %}

<!-- CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/tracking.css') }}">
<style>
/* ===== الجسم ===== */
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    overflow-x: hidden; /* منع الصفحة من التحرك يمين/يسار */
}

/* ===== حاوية الجدول ===== */
.table-container {
    width: 100%;
    max-height: calc(100vh - 120px); /* ارتفاع الشاشة ناقص الفلاتر/الهيدر */
    overflow-y: auto; /* التمرير العمودي */
    border: 1px solid #dee2e6;
}

/* ===== الجدول ===== */
#trackingTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    table-layout: auto;
}

#trackingTable th,
#trackingTable td {
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    text-align: center;
    vertical-align: middle;
}

/* السماح للعمود الثاني (الاسم) بالانكسار */
#trackingTable td:nth-child(2) {
    white-space: normal;
    word-wrap: break-word;
    max-width: 200px;
}

/* تثبيت رأس الجدول */
#trackingTable thead th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
}

/* الفلاتر */
.tracking-header {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    margin-bottom: 0.5rem;
}

.tracking-date {
    text-align: right;
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.tracking-filters {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.5rem;
}

.tracking-filters select {
    font-size: 0.875rem;
    min-width: 5rem;
    padding: 0.25rem 0.5rem;
}

/* زر إضافة عمود */
#addColumnBtn {
    margin-bottom: 0.5rem;
}

/* زر الملاحظات */
.note-btn {
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
}
</style>

<!-- HTML -->
<div class="container my-3">
    <div class="tracking-header">
        <div class="tracking-date">{{ today }}</div>
        <div class="tracking-filters">
            <strong>الصف: </strong>
            <select id="classSelect" class="form-control d-inline-block w-auto">
                <option value="">اختر صف</option>
                {% for c in classes %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
            </select>
            <strong>الشعبة: </strong>
            <select id="sectionSelect" class="form-control d-inline-block w-auto">
                <option value="">اختر شعبة</option>
                {% for s in sections %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <button id="addColumnBtn" class="btn btn-sm btn-primary">إضافة عمود جديد</button>

    <div class="table-container">
        <table class="table table-bordered" id="trackingTable">
            <thead class="table-light">
                <tr>
                    <th style="width:40px">#</th>
                    <th>الاسم</th>
                    <th>واجب</th>
                    <th>كتاب</th>
                    <th>مشاركة</th>
                    <th>مشاغبة</th>
                    <th>ملاحظة</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                {% set rec = records.get(student.id, {}) %}
                <tr data-class="{{ student.class_name }}" data-section="{{ student.section }}">
                    <td class="row-number"></td>
                    <td>{{ student.student_name }}</td>
                    <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="homework" {% if rec.homework %}checked{% endif %}></td>
                    <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="book" {% if rec.book %}checked{% endif %}></td>
                    <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="participation" {% if rec.participation %}checked{% endif %}></td>
                    <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="misbehavior" {% if rec.misbehavior %}checked{% endif %}></td>
                    <td>
                        <button class="btn btn-sm btn-warning note-btn" data-student="{{ student.id }}" {% if rec.note %}style="background:red"{% endif %}>
                            {% if rec.note %}تم إدخال ملاحظة{% else %}إضافة ملاحظة{% endif %}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- نافذة الملاحظة -->
<div id="noteModal" class="modal">
    <h5>إدخال ملاحظة</h5>
    <textarea id="noteText" rows="5" cols="50"></textarea><br><br>
    <button id="saveNote" class="btn btn-primary">حفظ</button>
    <button id="closeNote" class="btn btn-secondary">إغلاق</button>
</div>

<!-- JS -->
<script src="{{ url_for('static', filename='js/dashboard_table.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const table = document.getElementById("trackingTable");
    const classSelect = document.getElementById("classSelect");
    const sectionSelect = document.getElementById("sectionSelect");
    const checkboxes = document.querySelectorAll(".track-checkbox");

    // ======== وظيفة الفلترة وترقيم الصفوف =========
    function filterTable() {
        const selectedClass = classSelect.value;
        const selectedSection = sectionSelect.value;
        let visibleIndex = 1;
        table.querySelectorAll("tbody tr").forEach(row => {
            let show = true;
            if (selectedClass && row.dataset.class !== selectedClass) show = false;
            if (selectedSection && row.dataset.section !== selectedSection) show = false;
            row.style.display = show ? "" : "none";
            if (show) row.querySelector(".row-number").textContent = visibleIndex++;
        });
    }
    classSelect.addEventListener("change", filterTable);
    sectionSelect.addEventListener("change", filterTable);

    // ======== تحديث الشيك بوكس =========
    checkboxes.forEach(cb => {
        cb.addEventListener("change", () => {
            const studentId = cb.dataset.student;
            const field = cb.dataset.field;
            const value = cb.checked ? 1 : 0;
            fetch("/update_tracking", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ student_id: studentId, field: field, value: value })
            });
        });
    });

    // ======== نافذة الملاحظة =========
    let currentStudentId = null;
    const modal = document.getElementById("noteModal");
    const noteText = document.getElementById("noteText");
    document.querySelectorAll(".note-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            currentStudentId = btn.dataset.student;
            noteText.value = "";
            modal.style.display = "block";
        });
    });
    document.getElementById("saveNote").addEventListener("click", () => {
        fetch("/update_note", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ student_id: currentStudentId, note: noteText.value })
        }).then(() => {
            modal.style.display = "none";
            const btn = document.querySelector(`.note-btn[data-student='${currentStudentId}']`);
            btn.style.background = "red";
            btn.textContent = "تم إدخال ملاحظة";
        });
    });
    document.getElementById("closeNote").addEventListener("click", () => {
        modal.style.display = "none";
    });

    // ======== إضافة عمود جديد =====
    document.getElementById("addColumnBtn").addEventListener("click", () => {
        const newColumnName = prompt("ادخل اسم العمود الجديد:");
        if (!newColumnName) return;

        // إضافة رأس العمود
        const theadRow = table.querySelector("thead tr");
        const th = document.createElement("th");
        th.textContent = newColumnName;
        theadRow.appendChild(th);

        // إضافة خلايا جديدة للصفوف
        table.querySelectorAll("tbody tr").forEach(row => {
            const td = document.createElement("td");
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "اكتب هنا...";
            td.appendChild(input);
            row.appendChild(td);
        });
    });

    // ======== الترقيم عند التحميل الأول =========
    filterTable();
});
</script>

{% include 'partials/footer.html' %}
